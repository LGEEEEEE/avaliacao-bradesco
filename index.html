<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Esteira - Leitura Avan√ßada</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 900px; padding-top: 30px; padding-bottom: 50px; }
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 10px; margin-bottom: 20px; }
        .card-header { background-color: #fff; border-bottom: 1px solid #eee; font-weight: bold; color: #0d6efd; padding: 15px 20px; }
        .upload-area { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 30px; text-align: center; background: #fff; cursor: pointer; transition: 0.3s; }
        .upload-area:hover { border-color: #0d6efd; background-color: #f8fbff; }
        .btn-whatsapp { background-color: #25D366; color: white; font-weight: bold; border: none; }
        .btn-whatsapp:hover { background-color: #128C7E; color: white; }
        .modal-total { font-size: 1.25rem; font-weight: 700; color: #0d6efd; }
        .contract-item:hover { background-color: #f8f9fa; cursor: pointer; }
        
        /* Loading Overlay */
        #loadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
        <h5 class="mt-3 text-secondary" id="loadingText">Iniciando Intelig√™ncia Artificial...</h5>
        <small class="text-muted mt-2">Suporte a OCR e Leitura Nativa</small>
    </div>

    <div class="modal fade" id="modalParcelas" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-file-invoice-dollar"></i> Contratos Identificados</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small py-2">
                        <i class="fas fa-robot"></i> L√≥gica utilizada: <strong id="logicUsed">Detec√ß√£o Autom√°tica</strong>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="checkAll">
                            <label class="form-check-label fw-bold" for="checkAll">Selecionar Todos</label>
                        </div>
                        <span class="badge bg-secondary" id="countContratos">0 encontrados</span>
                    </div>

                    <div id="listaContratosContainer" class="list-group list-group-flush">
                        </div>
                </div>
                <div class="modal-footer justify-content-between bg-light">
                    <div>
                        <small class="text-muted d-block">Total Selecionado:</small>
                        <span id="displayTotalModal" class="modal-total">R$ 0,00</span>
                    </div>
                    <button type="button" class="btn btn-primary px-4" onclick="confirmarSelecao()">
                        Confirmar <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <h3 class="text-center mb-4"><i class="fas fa-file-contract text-primary"></i> CRM Esteira Inteligente</h3>

        <form id="crmForm">
            
            <div class="card">
                <div class="card-header">1. Upload do Extrato (SIAPE / Ex√©rcito / INSS)</div>
                <div class="card-body">
                    <input type="file" id="pdfUpload" accept=".pdf" hidden onchange="parsearPdf(this)">
                    <div class="upload-area" id="dropZone" onclick="document.getElementById('pdfUpload').click()">
                        <i class="fas fa-cloud-upload-alt fa-3x text-secondary mb-3"></i>
                        <h5>Clique ou Arraste o PDF aqui</h5>
                        <p class="text-muted small">O sistema detectar√° automaticamente se √© SIAPE, Ex√©rcito ou Imagem (OCR).</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">2. Dados do Cliente (Extra√ß√£o Auto)</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Nome Completo</label>
                            <input type="text" id="nome" class="form-control" style="background-color: #e9ecef;" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">CPF</label>
                            <input type="text" id="cpf" class="form-control" style="background-color: #e9ecef;" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Data de Nascimento *</label>
                            <input type="date" id="nascimento" class="form-control" required>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">E-mail *</label>
                            <input type="email" id="email" class="form-control" required>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Possui conta no Bradesco? *</label>
                            <select id="conta_bradesco" class="form-select" required>
                                <option value="">Selecione...</option>
                                <option value="Sim">Sim</option>
                                <option value="Nao">N√£o</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">3. Endere√ßo</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">CEP *</label>
                            <input type="text" id="cep" class="form-control" placeholder="00000-000" maxlength="9" onblur="buscarCep(this.value)" required>
                        </div>
                        <div class="col-md-9">
                            <label class="form-label">Endere√ßo Completo</label>
                            <input type="text" id="endereco_completo" class="form-control" required>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">4. Dados da Proposta</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Gerente *</label>
                            <select id="gerente" class="form-select" required>
                                <option value="">Selecione...</option>
                                <option value="Ana">Ana</option>
                                <option value="Carlos">Carlos</option>
                                <option value="Fernanda">Fernanda</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Banco Destino *</label>
                            <select id="banco" class="form-select" required>
                                <option value="">Selecione...</option>
                                <option value="Bradesco">Bradesco</option>
                                <option value="C6">C6</option>
                                <option value="Pan">Pan</option>
                                <option value="Daycoval">Daycoval</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-primary">Soma das Parcelas (Do Extrato) *</label>
                            <input type="text" id="parcela_total" class="form-control fw-bold" readonly required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Valor Pretendido *</label>
                            <input type="text" id="valor_pretendido" class="form-control money" required>
                        </div>
                         <div class="col-md-6">
                            <label class="form-label">Rating *</label>
                            <select id="rating" class="form-select" required>
                                <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                                <option value="D">D</option><option value="E">E</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Grau *</label>
                            <select id="grau" class="form-select" required>
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">5. Anexos e Envio</div>
                <div class="card-body">
                     <div class="row g-3">
                         <div class="col-md-6">
                            <label class="form-label">Documentos (RG/CNH/Contracheque) *</label>
                            <input type="file" id="arquivo_docs" class="form-control" multiple required>
                         </div>
                         <div class="col-md-6">
                            <label class="form-label">WhatsApp Destino *</label>
                            <input type="text" id="whatsapp_destino" class="form-control" value="5561998176188" required>
                         </div>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 mb-5">
                <button type="submit" class="btn btn-whatsapp btn-lg">
                    <i class="fab fa-whatsapp"></i> Gerar Proposta no WhatsApp
                </button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@latest/dist/tesseract.min.js'></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

        // ============================================
        // 1. UTILIT√ÅRIOS (Formatadores)
        // ============================================
        const showLoading = (msg) => {
            document.getElementById('loadingText').innerText = msg;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        const hideLoading = () => document.getElementById('loadingOverlay').style.display = 'none';

        const moedaParaFloat = (v) => parseFloat(String(v || '').replace('R$', '').trim().replace(/\./g, "").replace(",", ".")) || 0;
        const formatarMoeda = (v) => (v || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

        document.querySelectorAll('.money').forEach(input => {
            input.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                value = (value / 100).toFixed(2) + '';
                value = value.replace(".", ",");
                value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
                e.target.value = value;
            });
        });

        // ============================================
        // 2. L√ìGICA DE EXTRA√á√ÉO
        // ============================================
        
        async function parsearPdf(input) {
            const file = input instanceof HTMLInputElement ? input.files[0] : input.files[0];
            if (!file) return;

            showLoading('Analisando PDF...');
            
            // Limpa campos
            document.getElementById('nome').value = '';
            document.getElementById('cpf').value = '';

            const fileReader = new FileReader();
            fileReader.onload = async function () {
                let extractedText = '';
                try {
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let textFound = false;

                    // --- PLANO A: LEITURA R√ÅPIDA ---
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        if (textContent.items.length > 0) textFound = true;
                        extractedText += textContent.items.map(item => item.str).join('\n') + '\n\n';
                    }

                    const hasRealData = extractedText.toUpperCase().includes('CONSIGNAT√ÅRIA') || 
                                      extractedText.toUpperCase().includes('EMPR√âSTIMO') || 
                                      extractedText.toUpperCase().includes('CPF');

                    // --- PLANO B: OCR (TESSERACT) SE FALHAR ---
                    if (!textFound || extractedText.trim().length < 50 || !hasRealData) {
                        showLoading('Texto ileg√≠vel. Ativando OCR (Isso pode levar alguns segundos)...');
                        console.log("Ativando Tesseract...");
                        extractedText = ''; 
                        
                        if (typeof Tesseract === 'undefined') throw new Error("Erro Tesseract");
                        const worker = await Tesseract.createWorker('por');
                        
                        for (let i = 1; i <= pdf.numPages; i++) {
                            showLoading(`Lendo Imagem P√°gina ${i}/${pdf.numPages}...`);
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale: 2.0 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                            const { data: { text: ocrText } } = await worker.recognize(canvas);
                            extractedText += ocrText + '\n\n';
                        }
                        await worker.terminate();
                    }

                    // --- DETEC√á√ÉO AUTOM√ÅTICA DE TIPO ---
                    if (extractedText.includes("Extrato de Consigna√ß√µes Vigentes") || extractedText.includes("Rubrica\nSequ√™ncia")) {
                        console.log("Modo SIAPE Detectado");
                        document.getElementById('logicUsed').innerText = "SIAPE (Inteligente)";
                        processarPdfSiape(extractedText);
                    } else {
                        console.log("Modo Ex√©rcito/Geral Detectado");
                        document.getElementById('logicUsed').innerText = "Ex√©rcito/OCR (Padr√£o)";
                        processarPdfExercicio(extractedText);
                    }

                } catch (error) {
                    console.error(error);
                    hideLoading();
                    alert("Erro ao ler PDF: " + error.message);
                }
            };
            fileReader.readAsArrayBuffer(file);
        }

        // --- L√ìGICA SIAPE CORRIGIDA COM BASE NO DEPURADOR ---
        function processarPdfSiape(text) {
            console.log("Iniciando processamento SIAPE (L√≥gica de Linhas)...");

            // 1. Extra√ß√£o de Nome e CPF Baseada em Linhas
            // O padr√£o do seu PDF √©: 
            // Linha X: CPF (xxx.xxx.xxx-xx)
            // Linha X+1: Matr√≠cula
            // Linha X+2: Nome
            
            const linhas = text.split('\n').map(l => l.trim()); // Divide em linhas e limpa espa√ßos
            let cpfEncontrado = '';
            let nomeEncontrado = '';

            // Regex simples de CPF
            const regexCPF = /\d{3}\.\d{3}\.\d{3}-\d{2}/;

            for (let i = 0; i < linhas.length; i++) {
                const linhaAtual = linhas[i];
                
                // Se achou uma linha que PARECE um CPF
                if (regexCPF.test(linhaAtual)) {
                    cpfEncontrado = linhaAtual.match(regexCPF)[0];
                    
                    // O nome costuma estar 2 linhas abaixo no seu layout SIAPE
                    // Verifica se a linha i+2 existe
                    if (linhas[i+2]) {
                        const candidatoNome = linhas[i+2];
                        // Filtra para garantir que n√£o pegamos "Bruta" ou n√∫meros
                        if (candidatoNome.length > 3 && !candidatoNome.includes('Bruta') && !/\d/.test(candidatoNome)) {
                            nomeEncontrado = candidatoNome;
                            break; // Achou, para o loop
                        }
                    }
                }
            }

            // Preenche o formul√°rio se achou
            if(cpfEncontrado) document.getElementById('cpf').value = cpfEncontrado;
            if(nomeEncontrado) document.getElementById('nome').value = nomeEncontrado;
            
            // Fallback: Se a l√≥gica das linhas falhar, tenta a regex antiga
            if (!nomeEncontrado) {
                const regexFallback = /Nome\n[^\n]+\n[^\n]+\n([A-Z\s]+)/; // Tenta pegar blocos
                const matchFallback = text.match(regexFallback);
                if(matchFallback) document.getElementById('nome').value = matchFallback[1].trim();
            }

            // 2. Extra√ß√£o de Contratos (Mantido a l√≥gica que funciona)
            const rgxEmprestimos = /(EMPREST[^\n]+)\n(?:.|\n)*?(R\$\s*[\d\.,]+)\n(\d{2,3}\/\d{2,3})/g;
            let matches = [...text.matchAll(rgxEmprestimos)];
            
            let contratos = [];
            matches.forEach((m) => {
                const nomeBanco = m[1].replace(/^\d+\s*-\s*/, '').replace('EMPREST BCO PRIVADOS - ', '').replace('EMPREST BCO OFICIAL - ', '').trim();
                const valor = moedaParaFloat(m[2]);
                const [pagas, total] = m[3].split('/');
                
                if (parseInt(total) < 900) { 
                    contratos.push({ banco: nomeBanco, valor: valor, pagas: pagas, total: total });
                }
            });

            contratos.sort((a,b) => b.valor - a.valor);
            hideLoading();
            abrirModal(contratos);
        }

        // --- L√ìGICA EX√âRCITO/GERAL (MANTIDA) ---
        function processarPdfExercicio(text) {
            let cleanText = text.replace(/--- FIM DA P√ÅGINA \d+ ---/g, '');
            
            // 1. Nome e CPF
            const infoRegex = /(\d{9,12})\s*-\s*([\d.-]+)\s*-\s*([A-Z√Ä-√ö ]+)/;
            const matchInfo = text.match(infoRegex);
            if(matchInfo) {
                document.getElementById('cpf').value = matchInfo[2].trim();
                document.getElementById('nome').value = matchInfo[3].trim();
            } else {
                const cpfMatch = text.match(/(\d{3}\.\d{3}\.\d{3}-\d{2})/);
                if(cpfMatch) document.getElementById('cpf').value = cpfMatch[0];
            }

            // 2. Contratos
            let contratos = [];
            const blocos = cleanText.split(/Andamento|Em\s+Andamento/gi);
            
            if(blocos.length > 1) {
                blocos.forEach(bloco => {
                    if (!bloco.toUpperCase().includes('EMPR√âSTIMO') && !bloco.toUpperCase().includes('DEDUT')) return;
                    
                    const valorMatch = bloco.match(/R\$\s*([\d.,]+)/);
                    const parcMatch = bloco.match(/(\d+)\s*[\/e]\s*(\d{2,3})/);
                    
                    if(valorMatch && parcMatch) {
                        let nomeBanco = 'Empr√©stimo';
                        if(bloco.includes('BRADESCO')) nomeBanco = 'BRADESCO';
                        if(bloco.includes('SANTANDER')) nomeBanco = 'SANTANDER';
                        if(bloco.includes('POUPEX')) nomeBanco = 'POUPEX';
                        if(bloco.includes('SABEMI')) nomeBanco = 'SABEMI';
                        
                        const valor = moedaParaFloat(valorMatch[1]);
                        if(valor > 0) {
                            contratos.push({ banco: nomeBanco, valor: valor, pagas: parcMatch[1], total: parcMatch[2] });
                        }
                    }
                });
            } else {
                const tokens = text.replace(/\n/g, ' ').split(' ');
                for (let i = 0; i < tokens.length; i++) {
                    if (tokens[i].includes('R$') || (tokens[i].match(/\d+,\d{2}/) && tokens[i-1] === 'R$')) {
                         let valorStr = tokens[i].includes('R$') ? tokens[i] : tokens[i-1] + tokens[i];
                         let valor = moedaParaFloat(valorStr);
                         
                         const janela = tokens.slice(Math.max(0, i-15), Math.min(tokens.length, i+15)).join(' ');
                         const matchP = janela.match(/(\d{1,3})\/(\d{2,3})/);
                         
                         if(matchP && valor > 10) {
                             let banco = "Diversos";
                             ["BRADESCO","ITAU","PAN","C6","SANTANDER","SABEMI","POUPEX"].forEach(b => {
                                 if(janela.toUpperCase().includes(b)) banco = b;
                             });
                             if(!contratos.find(c => c.valor === valor && c.total === matchP[2])) {
                                 contratos.push({ banco: banco, valor: valor, pagas: matchP[1], total: matchP[2] });
                             }
                         }
                    }
                }
            }

            contratos.sort((a,b) => b.valor - a.valor);
            hideLoading();
            abrirModal(contratos);
        }

        // ============================================
        // 3. UI E MODAL
        // ============================================
        function abrirModal(contratos) {
            const container = document.getElementById("listaContratosContainer");
            container.innerHTML = '';
            document.getElementById('countContratos').textContent = `${contratos.length} encontrados`;

            if (contratos.length === 0) {
                container.innerHTML = '<div class="alert alert-warning text-center">Nenhum contrato padr√£o identificado.</div>';
            } else {
                contratos.forEach((c) => {
                    const html = `
                    <label class="list-group-item d-flex gap-3 align-items-center contract-item">
                        <input class="form-check-input flex-shrink-0 item-parcela" type="checkbox" value="${c.valor}" onchange="calcTotal()">
                        <div class="d-flex w-100 justify-content-between">
                            <div>
                                <h6 class="mb-0 fw-bold text-dark">${c.banco}</h6>
                                <small class="text-muted">Parcela ${c.pagas} de ${c.total}</small>
                            </div>
                            <div class="text-end">
                                <span class="fs-6 fw-bold text-primary">${formatarMoeda(c.valor)}</span>
                            </div>
                        </div>
                    </label>`;
                    container.insertAdjacentHTML('beforeend', html);
                });
            }

            document.getElementById('checkAll').onclick = (e) => {
                document.querySelectorAll('.item-parcela').forEach(ck => ck.checked = e.target.checked);
                calcTotal();
            };
            
            calcTotal();
            new bootstrap.Modal(document.getElementById('modalParcelas')).show();
        }

        function calcTotal() {
            let total = 0;
            document.querySelectorAll('.item-parcela:checked').forEach(el => total += parseFloat(el.value));
            document.getElementById('displayTotalModal').textContent = formatarMoeda(total);
        }

        function confirmarSelecao() {
            const txt = document.getElementById('displayTotalModal').textContent;
            document.getElementById('parcela_total').value = txt.replace('R$', '').trim();
            bootstrap.Modal.getInstance(document.getElementById('modalParcelas')).hide();
        }

        async function buscarCep(cep) {
            const clean = cep.replace(/\D/g, '');
            if(clean.length === 8) {
                try {
                    const r = await fetch(`https://viacep.com.br/ws/${clean}/json/`);
                    const d = await r.json();
                    if(!d.erro) document.getElementById('endereco_completo').value = `${d.logradouro}, ${d.bairro} - ${d.localidade}/${d.uf}`;
                } catch(e){}
            }
        }

        document.getElementById('crmForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const getVal = (id) => document.getElementById(id).value;
            const msg = `*üöÄ SIMULA√á√ÉO BRADESCO*

CLIENTE:

Nome: ${getVal('nome')}
CPF: ${getVal('cpf')}
Nasc: ${getVal('nascimento').split('-').reverse().join('/')}
Email: ${getVal('email')}

ENDERE√áO:

${getVal('cep')} - ${getVal('endereco_completo')}

PROPOSTA

Gerente: ${getVal('gerente')}
Banco Destino: *${getVal('banco')}*
Soma Parcelas: *R$ ${getVal('parcela_total')}*
L√≠quido Pretendido: *R$ ${getVal('valor_pretendido')}*
Rating: ${getVal('rating')} | Grau: ${getVal('grau')}

_Por favor, verifique os anexos acima._`;
            
            const phone = getVal('whatsapp_destino').replace(/\D/g, '');
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
        });
        
        // Drag Drop
        const dz = document.getElementById('dropZone');
        dz.ondragover = (e) => { e.preventDefault(); dz.style.background = '#f8fbff'; };
        dz.ondragleave = (e) => { e.preventDefault(); dz.style.background = '#fff'; };
        dz.ondrop = (e) => {
            e.preventDefault(); dz.style.background = '#fff';
            if(e.dataTransfer.files[0]) {
                document.getElementById('pdfUpload').files = e.dataTransfer.files;
                parsearPdf({files: e.dataTransfer.files});
            }
        };
    </script>
</body>
</html>